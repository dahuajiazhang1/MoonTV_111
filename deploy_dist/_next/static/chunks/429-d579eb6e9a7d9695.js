(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[429],{1054:function(){},904:function(e,t,r){"use strict";var s=r(7569),a=r(4819),n=r(359),i=r(5663),l=r(2038),o=r(8474);t.Z=e=>{var t;let{isOpen:c,onClose:d,onAddTask:u,initialUrl:m="",initialTitle:h="",skipConfig:g}=e,[x,f]=(0,i.useState)(!1),[p,w]=(0,i.useState)(null),[y,b]=(0,i.useState)("TS"),[v,S]=(0,i.useState)(!1),[k,j]=(0,i.useState)(1),[N,M]=(0,i.useState)(0),[E,P]=(0,i.useState)(6),[C,L]=(0,i.useState)(3),[U,T]=(0,i.useState)("disabled"),[I,D]=(0,i.useState)(""),[A,W]=(0,i.useState)(""),[R,z]=(0,i.useState)(!1),[B,F]=(0,i.useState)({serviceWorker:!1,fileSystem:!1,blob:!0});(0,i.useEffect)(()=>{Promise.all([r.e(846).then(r.bind(r,2846)),r.e(623).then(r.bind(r,5623))]).then(e=>{let[t,r]=e,s=t.supportsFileSystemAccess();F({serviceWorker:r.isStreamSaverSupported(),fileSystem:s,blob:!0})}).catch(e=>{console.error("Failed to detect stream saver support:",e)})},[]),(0,i.useEffect)(()=>{{let e=localStorage.getItem("downloadType"),t=localStorage.getItem("concurrency"),r=localStorage.getItem("maxRetries"),s=localStorage.getItem("streamMode");e&&b(e),t&&P(parseInt(t,10)),r&&L(parseInt(r,10)),s&&T(s)}},[]),(0,i.useEffect)(()=>{localStorage.setItem("downloadType",y),localStorage.setItem("concurrency",E.toString()),localStorage.setItem("maxRetries",String(C)),localStorage.setItem("streamMode",U)},[y,E,C,U]),(0,i.useEffect)(()=>{c&&(D(m||""),W(h||""),w(null),j(1),M(0))},[c,m,h]),(0,i.useEffect)(()=>{c&&h&&(W(h),p&&w({...p,title:h}))},[c,h]),(0,i.useEffect)(()=>{c&&I&&!p&&!x&&_()},[c,I]),(0,i.useEffect)(()=>{if(p&&R&&g){let e=p.segmentDurations||[],t=1;if(g.intro_time>0&&e.length>0){let r=0,s=0;for(let t=0;t<e.length;t++)if(r+e[t]<=g.intro_time)r+=e[t],s=t;else break;t=Math.min(p.tsUrlList.length,s+2)}let r=p.tsUrlList.length;if(0!==g.outro_time&&e.length>0){let t=0,s=(p.durationSecond||0)+g.outro_time;r=p.tsUrlList.length;for(let a=0;a<e.length;a++)if((t+=e[a])>=s){r=a+1;break}r=Math.max(1,Math.min(p.tsUrlList.length,r))}j(t),M(r)}},[p,R,g]);let _=async()=>{if(I){f(!0);try{let e=await (0,l.BV)(I);e.title=A||e.title,e.type=y,w(e),M(e.tsUrlList.length)}catch(e){}finally{f(!1)}}};return c?(0,s.jsx)("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex items-center justify-center p-4",children:(0,s.jsxs)("div",{className:"relative w-full max-w-2xl rounded-lg bg-white p-6 shadow-xl dark:bg-gray-800 max-h-[90vh] overflow-y-auto",children:[(0,s.jsx)("button",{onClick:()=>{d(),w(null),D(""),W("")},className:"absolute right-4 top-4 text-gray-400 transition-colors hover:text-gray-600 dark:hover:text-gray-200",children:(0,s.jsx)(a.Z,{className:"h-6 w-6"})}),(0,s.jsx)("h2",{className:"mb-6 text-2xl font-bold text-gray-900 dark:text-white",children:"下载 M3U8 视频"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"M3U8 地址"}),(0,s.jsx)("input",{type:"text",value:I,onChange:e=>D(e.target.value),className:"w-full rounded-lg border border-gray-300 px-4 py-2 text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white",placeholder:"请输入 M3U8 链接地址"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"保存标题"}),(0,s.jsx)("input",{type:"text",value:p?p.title:A,onChange:e=>{let t=e.target.value;W(t),p&&w({...p,title:t})},className:"w-full rounded-lg border border-gray-300 px-4 py-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white",placeholder:"请输入文件名"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"保存格式"}),(0,s.jsxs)("div",{className:"flex gap-4",children:[(0,s.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,s.jsx)("input",{type:"radio",name:"format",value:"TS",checked:"TS"===y,onChange:()=>b("TS"),className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"TS 格式"})]}),(0,s.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,s.jsx)("input",{type:"radio",name:"format",value:"MP4",checked:"MP4"===y,onChange:()=>b("MP4"),className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"MP4 格式"})]})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:["下载线程数: ",E]}),(0,s.jsx)("input",{type:"range",min:"1",max:"16",value:E,onChange:e=>P(parseInt(e.target.value,10)),className:"w-full"}),(0,s.jsxs)("div",{className:"flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1",children:[(0,s.jsx)("span",{children:"1 线程"}),(0,s.jsx)("span",{children:"16 线程"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:["失败重试次数: ",C]}),(0,s.jsx)("input",{type:"range",min:"0",max:"10",value:C,onChange:e=>L(parseInt(e.target.value,10)),className:"w-full"}),(0,s.jsxs)("div",{className:"flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1",children:[(0,s.jsx)("span",{children:"不重试"}),(0,s.jsx)("span",{children:"10 次"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"下载模式"}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,s.jsx)("input",{type:"radio",name:"streamMode",value:"disabled",checked:"disabled"===U,onChange:()=>T("disabled"),className:"w-4 h-4"}),(0,s.jsxs)("div",{className:"text-sm flex-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"text-green-500",children:"✓"}),(0,s.jsx)("span",{className:"text-gray-700 dark:text-gray-300 font-medium",children:"普通模式"})]}),(0,s.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 ml-4",children:"内存下载，适合小文件（<500MB）"})]})]}),(0,s.jsxs)("label",{className:"flex items-center gap-2 ".concat(B.serviceWorker?"cursor-pointer":"opacity-60"),children:[(0,s.jsx)("input",{type:"radio",name:"streamMode",value:"service-worker",checked:"service-worker"===U,onChange:()=>T("service-worker"),disabled:!B.serviceWorker,className:"w-4 h-4 disabled:cursor-not-allowed"}),(0,s.jsxs)("div",{className:"text-sm flex-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[B.serviceWorker?(0,s.jsx)("span",{className:"text-green-500",children:"✓"}):(0,s.jsx)("span",{className:"text-red-500",children:"✗"}),(0,s.jsx)("span",{className:"font-medium ".concat(B.serviceWorker?"text-gray-700 dark:text-gray-300":"text-gray-400 dark:text-gray-500"),children:"Service Worker 流式下载"})]}),(0,s.jsx)("div",{className:"text-xs ml-4 ".concat(B.serviceWorker?"text-gray-500 dark:text-gray-400":"text-gray-400 dark:text-gray-500"),children:B.serviceWorker?"边下边存，无大小限制，适合超大文件":"不支持：需要HTTPS或本地环境"})]})]}),(0,s.jsxs)("label",{className:"flex items-center gap-2 ".concat(B.fileSystem?"cursor-pointer":"opacity-60"),children:[(0,s.jsx)("input",{type:"radio",name:"streamMode",value:"file-system",checked:"file-system"===U,onChange:()=>T("file-system"),disabled:!B.fileSystem,className:"w-4 h-4 disabled:cursor-not-allowed"}),(0,s.jsxs)("div",{className:"text-sm flex-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[B.fileSystem?(0,s.jsx)("span",{className:"text-green-500",children:"✓"}):(0,s.jsx)("span",{className:"text-red-500",children:"✗"}),(0,s.jsx)("span",{className:"font-medium ".concat(B.fileSystem?"text-gray-700 dark:text-gray-300":"text-gray-400 dark:text-gray-500"),children:"文件系统直写"})]}),(0,s.jsx)("div",{className:"text-xs ml-4 ".concat(B.fileSystem?"text-gray-500 dark:text-gray-400":"text-gray-400 dark:text-gray-500"),children:B.fileSystem?"直接写入磁盘，无大小限制（推荐）":"不支持：需要Chrome/Edge浏览器"})]})]})]})]}),x&&(0,s.jsxs)("div",{className:"flex items-center gap-2 text-blue-600 dark:text-blue-400",children:[(0,s.jsx)(n.Z,{className:"h-5 w-5 animate-spin"}),(0,s.jsx)("span",{children:"正在解析 M3U8..."})]}),p&&(0,s.jsxs)("div",{className:"rounded-lg bg-gray-50 p-4 dark:bg-gray-700/50",children:[(0,s.jsx)("h3",{className:"mb-2 font-medium text-gray-900 dark:text-white",children:"解析结果"}),(0,s.jsxs)("div",{className:"space-y-1 text-sm text-gray-600 dark:text-gray-300",children:[(0,s.jsxs)("p",{children:["总时长: ",(0,o.m)(p.durationSecond||0)]}),(0,s.jsxs)("p",{children:["片段数: ",p.tsUrlList.length]}),(null===(t=p.aesConf)||void 0===t?void 0:t.key)&&(0,s.jsx)("p",{className:"text-yellow-600 dark:text-yellow-400",children:"\uD83D\uDD12 已加密 (AES-128)"})]}),(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,s.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,s.jsx)("input",{type:"checkbox",checked:v,onChange:e=>S(e.target.checked),className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"范围下载"})]}),v&&(0,s.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,s.jsx)("input",{type:"checkbox",checked:R,onChange:e=>{let t=e.target.checked;if(z(t),t&&p){let e=p.tsUrlList.length,t=(p.durationSecond||0)/e;if(t>0){let r=1;g&&g.intro_time>0&&(r=Math.min(e,Math.ceil(g.intro_time/t)+1));let s=e;g&&0!==g.outro_time&&(s=Math.max(1,Math.min(e,Math.floor((p.durationSecond+g.outro_time)/t)))),j(r),M(s)}}},className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:"同步跳过配置"})]})]}),v&&(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("span",{className:"block text-xs text-gray-600 dark:text-gray-400",children:"起始片段:"}),(0,s.jsx)("input",{type:"number",min:1,max:p.tsUrlList.length,value:k,onChange:e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=1),j(t=Math.max(1,Math.min(p.tsUrlList.length,t)))},className:"w-20 px-2 py-1 rounded text-sm bg-[#f5f5f5] dark:bg-gray-800 text-gray-900 dark:text-gray-100 outline-none border-none focus:outline-none focus:border-none focus:ring-0 ml-1"})]}),(0,s.jsx)("input",{type:"range",min:"1",max:p.tsUrlList.length,value:k,onChange:e=>j(parseInt(e.target.value,10)),className:"w-full"}),(0,s.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:(0,o.m)(p.segmentDurations?p.segmentDurations.slice(0,k-1).reduce((e,t)=>e+t,0):0)})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("span",{className:"block text-xs text-gray-600 dark:text-gray-400",children:"结束片段:"}),(0,s.jsx)("input",{type:"number",min:1,max:p.tsUrlList.length,value:N,onChange:e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=1),M(t=Math.max(1,Math.min(p.tsUrlList.length,t)))},className:"w-20 px-2 py-1 rounded text-sm bg-[#f5f5f5] dark:bg-gray-800 text-gray-900 dark:text-gray-100 outline-none border-none focus:outline-none focus:border-none focus:ring-0 ml-1"})]}),(0,s.jsx)("input",{type:"range",min:"1",max:p.tsUrlList.length,value:N,onChange:e=>M(parseInt(e.target.value,10)),className:"w-full"}),(0,s.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:(0,o.m)(p.segmentDurations?p.segmentDurations.slice(0,N).reduce((e,t)=>e+t,0):0)})]})]})]})]}),(0,s.jsxs)("div",{className:"flex gap-3 pt-4",children:[(0,s.jsx)("button",{onClick:_,disabled:!I||x,className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:x?"解析中...":"解析"}),(0,s.jsx)("button",{onClick:()=>{p&&(u({url:I,title:p.title,downloadType:y,concurrency:E,rangeMode:v,startSegment:k,endSegment:N,streamMode:U,maxRetries:C,parsedTask:p}),d(),w(null),D(""),W(""))},disabled:!p,className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:"添加下载"})]})]})]})}):null}},3593:function(e,t,r){"use strict";r.d(t,{GlobalErrorIndicator:function(){return n},p:function(){return i}});var s=r(7569),a=r(5663);function n(){let[e,t]=(0,a.useState)(null),[r,n]=(0,a.useState)(!1),[i,l]=(0,a.useState)(!1);return((0,a.useEffect)(()=>{let r=r=>{let{message:s}=r.detail,a={id:Date.now().toString(),message:s,timestamp:Date.now()};e?(t(a),l(!0),setTimeout(()=>{l(!1)},200)):t(a),n(!0)};return window.addEventListener("globalError",r),()=>{window.removeEventListener("globalError",r)}},[e]),r&&e)?(0,s.jsx)("div",{className:"fixed top-4 right-4 z-[2000]",children:(0,s.jsxs)("div",{className:"bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center justify-between min-w-[300px] max-w-[400px] transition-all duration-300 ".concat(i?"scale-105 bg-red-400":"scale-100 bg-red-500"," animate-fade-in"),children:[(0,s.jsx)("span",{className:"text-sm font-medium flex-1 mr-3",children:e.message}),(0,s.jsx)("button",{onClick:()=>{n(!1),t(null),l(!1)},className:"text-white hover:text-red-100 transition-colors flex-shrink-0","aria-label":"关闭错误提示",children:(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}):null}function i(e){window.dispatchEvent(new CustomEvent("globalError",{detail:{message:e}}))}},8474:function(e,t,r){"use strict";function s(e){if(0===e)return"00:00";let t=Math.floor(e/3600),r=Math.floor(e%3600/60),s=Math.round(e%60);return 0===t?"".concat(r.toString().padStart(2,"0"),":").concat(s.toString().padStart(2,"0")):"".concat(t.toString().padStart(2,"0"),":").concat(r.toString().padStart(2,"0"),":").concat(s.toString().padStart(2,"0"))}r.d(t,{m:function(){return s}})},2038:function(e,t,r){"use strict";r.d(t,{BV:function(){return o},MP:function(){return g},jz:function(){return d},mergeSegments:function(){return m},qA:function(){return u},triggerDownload:function(){return h},zc:function(){return i}});var s=r(9689),a=r.n(s),n=r(9309);class i{pause(){this.isPaused||(this.isPaused=!0,this.pausePromise=new Promise(e=>{this.resumeResolve=e}))}resume(){this.isPaused&&this.resumeResolve&&(this.isPaused=!1,this.resumeResolve(),this.resumeResolve=null,this.pausePromise=null)}async waitIfPaused(){this.isPaused&&this.pausePromise&&await this.pausePromise}getPaused(){return this.isPaused}destroy(){this.isPaused=!1,this.resumeResolve&&(this.resumeResolve(),this.resumeResolve=null),this.pausePromise=null}constructor(){this.isPaused=!1,this.resumeResolve=null,this.pausePromise=null}}function l(e,t){if(/^http/.test(e))return e;let r=new URL(t),s=r.protocol,a=r.host;if(e.startsWith("/"))return"".concat(s,"//").concat(a).concat(e);let n=t.split("/");return n.pop(),"".concat(n.join("/"),"/").concat(e)}async function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(t>5)throw Error("M3U8 解析层级过深，可能存在循环引用");let r=await fetch(e),s=await r.text();if("#EXTM3U"!==s.substring(0,7).toUpperCase())throw Error("无效的 m3u8 链接");if(s.includes("#EXT-X-STREAM-INF")){let r=function(e,t){let r=e.split("\n"),s=[];for(let e=0;e<r.length;e++){let a=r[e].trim();if(a.startsWith("#EXT-X-STREAM-INF")){let n=a.match(/BANDWIDTH=(\d+)/),i=a.match(/RESOLUTION=([\dx]+)/);if(e+1<r.length){let a=r[e+1].trim();a&&!a.startsWith("#")&&s.push({url:l(a,t),bandwidth:n?parseInt(n[1]):void 0,resolution:i?i[1]:void 0})}}}return 0===s.length?null:(s.sort((e,t)=>(t.bandwidth||0)-(e.bandwidth||0)),s[0].url)}(s,e);if(!r)throw Error("无法从主播放列表中提取子播放列表");return o(r,t+1)}let a={url:e,title:function(e){try{let t=new URL(e).searchParams.get("title");if(t)return t}catch(e){}let t=new Date;return"video_".concat(t.getFullYear()).concat(String(t.getMonth()+1).padStart(2,"0")).concat(String(t.getDate()).padStart(2,"0"),"_").concat(String(t.getHours()).padStart(2,"0")).concat(String(t.getMinutes()).padStart(2,"0")).concat(String(t.getSeconds()).padStart(2,"0"))}(e),type:"TS",tsUrlList:[],finishList:[],downloadIndex:0,finishNum:0,errorNum:0,aesConf:{method:"",uri:"",iv:"",key:""},durationSecond:0,segmentDurations:[],rangeDownload:{startSegment:1,endSegment:0,targetSegment:0},totalSize:0},n=s.split("\n"),i=null;for(let t of n)if(t.startsWith("#EXTINF:"))i=parseFloat(t.split("#EXTINF:")[1]),a.durationSecond+=i;else if(/^[^#]/.test(t)&&t.trim()){let r=l(t.trim(),e);a.tsUrlList.push(r),a.finishList.push({title:t.trim(),status:""}),a.segmentDurations.push(null!=i?i:0),i=null}if(a.rangeDownload.endSegment=a.tsUrlList.length,a.rangeDownload.targetSegment=a.tsUrlList.length,a.totalSize=Math.round(262144*a.durationSecond),s.includes("#EXT-X-KEY")){let t=s.match(/METHOD=([^,\s]+)/),r=s.match(/URI="([^"]+)"/),n=s.match(/IV=([^,\s]+)/);if(a.aesConf.method=t?t[1]:"",a.aesConf.uri=r?l(r[1],e):"",a.aesConf.iv=n?n[1]:"",a.aesConf.uri){let e=await fetch(a.aesConf.uri),t=await e.arrayBuffer();a.aesConf.key=c(t)}}return a}function c(e){let t=new Uint8Array(e),r=t.length,s=[];for(let e=0;e<r;e+=1)s[e>>>2]|=(255&t[e])<<24-e%4*8;return a().lib.WordArray.create(s,r)}function d(e,t,r){if(!t)return e;let s=c(e),n=r?a().enc.Hex.parse(r.replace("0x","")):a().lib.WordArray.create(),i=a().AES.decrypt({ciphertext:s},t,{iv:n,mode:a().mode.CBC,padding:a().pad.Pkcs7}),l=new Uint8Array(i.sigBytes),o=i.words;for(let e=0;e<i.sigBytes;e++)l[e]=o[e>>>2]>>>24-e%4*8&255;return l.buffer}async function u(e,t){let r=await fetch(e,{signal:t});if(!r.ok)throw Error("下载失败: ".concat(r.status));return r.arrayBuffer()}function m(e,t){return new Blob(e,{type:"MP4"===t?"video/mp4":"video/MP2T"})}function h(e,t,r){let s=URL.createObjectURL(e),a=document.createElement("a");a.href=s;let n=t.replace(/\.(mp4|ts|m3u8)$/i,"");a.download="".concat(n,".").concat(r.toLowerCase()),a.style.display="none",document.body.appendChild(a),a.click(),setTimeout(()=>{document.body.removeChild(a),URL.revokeObjectURL(s)},100)}async function g(e,t,s,a){let i,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"disabled",c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:3,g=arguments.length>7?arguments[7]:void 0,{startSegment:x,endSegment:f}=e.rangeDownload,p=f-x+1,w=e.segmentDurations.slice(x-1,f).reduce((e,t)=>e+t,0),y=null,b=null,v=new Map,S=x-1,k=Promise.resolve();if("disabled"!==o)try{let t=e.title.replace(/\.(mp4|ts|m3u8)$/i,""),s="MP4"===e.type?".mp4":".ts",a=t+s;a.toLowerCase().endsWith(s)||(a+=s);let i=e.totalSize||void 0,l=null;if("service-worker"===o){let{createWriteStream:e}=await r.e(623).then(r.bind(r,5623));l=e(a),console.log("✅ 使用 Service Worker 流式下载")}else if("file-system"===o){let{createFileSystemWriteStream:e}=await r.e(846).then(r.bind(r,2846));if(l=await e(a,i))console.log("✅ 使用文件系统直写");else throw Error("用户取消了文件选择")}l&&(y=l.getWriter(),"MP4"===e.type&&(b=new n.op(y,w),console.log("✅ 启用 MP4 流式转码")))}catch(e){console.error("创建流式写入器失败，降级为普通下载:",e),y=null}let j=0,N=async()=>{await k,y&&(k=k.then(async()=>{for(;v.has(S);){if(a&&await a.waitIfPaused(),null==s?void 0:s.aborted)throw Error("下载已取消");let e=v.get(S);if("failed"===e){console.warn("⚠️ 跳过失败片段 ".concat(S+1)),v.delete(S),S++;continue}if(!e)break;try{if(b)await b.pushAndTransmux(new Uint8Array(e));else if(y)await y.write(new Uint8Array(e));else throw Error("Writer is not initialized");v.delete(S),S++}catch(e){throw console.error("片段 ".concat(S+1," 写入流失败:"),e),Error("写入失败: ".concat(e instanceof Error?e.message:String(e)))}}}),await k)};g&&"disabled"!==o&&y&&(g.current=async()=>{if(y)try{await N(),b?await b.finish():await y.close(),null==t||t({current:j,total:p,percentage:100,status:"done",message:"下载完成！"})}catch(e){throw console.error("提前完成时关闭流失败:",e),e}});let M=[];for(let e=x-1;e<f;e++)M.push(e);let E=async function(r){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(null==s?void 0:s.aborted)throw Error("下载已取消");a&&await a.waitIfPaused(),e.finishList[r].status="downloading",e.finishList[r].retryCount=n;try{if(a&&await a.waitIfPaused(),null==s?void 0:s.aborted)throw Error("下载已取消");let i=await u(e.tsUrlList[r],s);if(a&&await a.waitIfPaused(),(null==s?void 0:s.aborted)||(e.aesConf.key&&(i=d(i,e.aesConf.key,e.aesConf.iv)),a&&await a.waitIfPaused(),null==s?void 0:s.aborted)||(y?(v.set(r,i),await N()):(e.downloadedSegments||(e.downloadedSegments=new Map),e.downloadedSegments.set(r,i)),a&&await a.waitIfPaused(),null==s?void 0:s.aborted))throw Error("下载已取消");e.finishList[r].status="success",j++,e.finishNum++,null==t||t({current:j,total:p,percentage:Math.floor(j/p*100),status:"downloading",message:"正在下载 ".concat(j,"/").concat(p," 个片段 (").concat(l," 线程)").concat(n>0?" [重试成功]":"")})}catch(s){if(s instanceof Error&&s.message.includes("写入失败"))throw console.error("写入流失败，用户可能取消了下载，停止下载任务"),s;if(n<c)return console.warn("片段 ".concat(r+1," 下载失败，").concat(1e3,"ms 后进行第 ").concat(n+1," 次重试...")),null==t||t({current:j,total:p,percentage:Math.floor(j/p*100),status:"downloading",message:"片段 ".concat(r+1," 重试中 (").concat(n+1,"/").concat(c,")")}),await new Promise(e=>setTimeout(e,1e3)),E(r,n+1);e.errorNum++,e.finishList[r].status="error",e.finishList[r].retryCount=n,console.error("片段 ".concat(r+1," 下载失败（已重试 ").concat(c," 次）:"),s),"disabled"!==o&&y?(v.set(r,"failed"),await N(),console.warn("边下边存模式：已跳过失败片段 ".concat(r+1,"，继续下载...")),null==t||t({current:j,total:p,percentage:Math.floor(j/p*100),status:"downloading",message:"片段 ".concat(r+1," 失败已跳过 (已完成 ").concat(j,"/").concat(p,")")})):null==t||t({current:j,total:p,percentage:Math.floor(j/p*100),status:"downloading",message:"片段 ".concat(r+1," 下载失败，等待重试 (已完成 ").concat(j,"/").concat(p,")")})}},P=[],C=async()=>{for(;M.length>0;){if(null==s?void 0:s.aborted)throw Error("下载已取消");a&&await a.waitIfPaused();let e=M.shift();void 0!==e&&await E(e)}};for(let e=0;e<Math.min(l,p);e++)P.push(C());try{if(await Promise.all(P),y){try{await N(),b?await b.finish():await y.close(),null==t||t({current:j,total:p,percentage:100,status:"done",message:"下载完成！"})}catch(e){throw console.error("关闭流失败:",e),e}return}}catch(e){if(y)try{await y.abort()}catch(e){console.error("中止流失败:",e)}throw e}if(!e.downloadedSegments||0===e.downloadedSegments.size)throw Error("没有成功下载的片段");if(e.finishList.slice(x-1,f).some(e=>"error"===e.status)){let r=e.finishList.slice(x-1,f).filter(e=>"error"===e.status).length;console.warn("⚠️ 有 ".concat(r," 个片段下载失败，等待手动重试...")),null==t||t({current:j,total:p,percentage:Math.round(j/p*100),status:"downloading",message:"".concat(r," 个片段失败，等待重试...")});return}let L=[];for(let t=x-1;t<f;t++){let r=e.downloadedSegments.get(t);r&&L.push(r)}if(null==t||t({current:L.length,total:f-x+1,percentage:100,status:"processing",message:"MP4"===e.type?"正在转码为 MP4 格式...":"正在合并视频文件..."}),"MP4"===e.type){let t=e.segmentDurations.slice(x-1,f).reduce((e,t)=>e+t,0);i=(0,n.transmuxTSToMP4)(L,t)}else i=m(L,e.type);h(i,e.title,e.type),null==t||t({current:L.length,total:f-x+1,percentage:100,status:"done",message:"下载完成！"})}},9309:function(e,t,r){"use strict";r.d(t,{op:function(){return l},transmuxTSToMP4:function(){return i}});var s=r(8761),a=r.n(s);class n{push(e){this.transmuxer.push(e)}flush(){this.transmuxer.flush()}getMP4Blob(){if(0===this.mp4Segments.length)throw Error("没有可用的 MP4 数据");let e=new Uint8Array(this.mp4Segments.reduce((e,t)=>e+t.byteLength,0)),t=0;for(let r of this.mp4Segments)e.set(r,t),t+=r.byteLength;return new Blob([e],{type:"video/mp4"})}reset(){this.mp4Segments=[],this.isInitialized=!1,this.transmuxer=new(a()).mp4.Transmuxer({keepOriginalTimestamps:!0,duration:this.duration}),this.transmuxer.on("data",e=>{let t=new Uint8Array(e.initSegment.byteLength+e.data.byteLength);t.set(e.initSegment,0),t.set(e.data,e.initSegment.byteLength),this.mp4Segments.push(t)}),this.transmuxer.on("done",()=>{this.isInitialized=!0})}isReady(){return this.isInitialized}constructor(e){this.mp4Segments=[],this.isInitialized=!1,this.duration=e||0,this.transmuxer=new(a()).mp4.Transmuxer({keepOriginalTimestamps:!0,duration:this.duration}),this.transmuxer.on("data",e=>{let t=new Uint8Array(e.initSegment.byteLength+e.data.byteLength);t.set(e.initSegment,0),t.set(e.data,e.initSegment.byteLength),this.mp4Segments.push(t)}),this.transmuxer.on("done",()=>{this.isInitialized=!0})}}function i(e,t){let r=new n(t);for(let t of e)r.push(new Uint8Array(t));return r.flush(),r.getMP4Blob()}class l{setWriter(e){this.writer=e}async pushAndTransmux(e){if(this.writeError||(this.transmuxer.push(e),this.transmuxer.flush(),await new Promise(e=>setTimeout(e,0)),this.writeError))throw this.writeError}async finish(){if(this.transmuxer.flush(),this.writer)try{await this.writer.close()}catch(e){console.error("关闭写入流失败:",e)}}getSegmentCount(){return this.segmentCount}reset(){this.segmentCount=0,this.isFirstSegment=!0,this.transmuxer=new(a()).mp4.Transmuxer({keepOriginalTimestamps:!0,duration:this.duration}),this.transmuxer.on("data",async e=>{try{this.isFirstSegment&&e.initSegment&&(this.writer&&await this.writer.write(new Uint8Array(e.initSegment)),this.isFirstSegment=!1),e.data&&this.writer&&await this.writer.write(new Uint8Array(e.data)),this.segmentCount++}catch(e){throw console.error("写入 MP4 数据失败:",e),e}})}constructor(e,t){this.writer=null,this.segmentCount=0,this.isFirstSegment=!0,this.writeError=null,this.pendingWrites=[],this.writer=e||null,this.duration=t||0,this.transmuxer=new(a()).mp4.Transmuxer({keepOriginalTimestamps:!0,duration:this.duration}),this.transmuxer.on("data",async e=>{if(!this.writeError)try{this.isFirstSegment&&e.initSegment&&(this.writer&&await this.writer.write(new Uint8Array(e.initSegment)),this.isFirstSegment=!1),e.data&&this.writer&&await this.writer.write(new Uint8Array(e.data)),this.segmentCount++}catch(e){throw console.error("写入 MP4 数据失败:",e),this.writeError=e instanceof Error?e:Error(String(e)),e}})}}}}]);