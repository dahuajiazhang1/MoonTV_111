(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{9887:function(e,t,r){Promise.resolve().then(r.bind(r,1570))},2956:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});let n=(0,r(9818).Z)("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]])},669:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});let n=(0,r(9818).Z)("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]])},1570:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return C}});var n=r(7569),a=r(669),s=r(8448),l=r(2956),o=r(1383),i=r(5663),c=r(1816);function u(){var e;return(null===(e=window.RUNTIME_CONFIG)||void 0===e?void 0:e.DANMU_API_BASE_URL)||c.env.NEXT_PUBLIC_DANMU_API_BASE_URL||""}async function d(e,t){if(!e)throw Error("fileName 不能为空");let r=u();try{let n=await fetch("".concat(r,"/api/v2/match"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:e}),signal:t});if(!n.ok)throw Error("HTTP error! status = ".concat(n.status));return(await n.json()).matches||[]}catch(e){throw console.error("matchAnime 失败:",e),e}}async function m(e){if(!e)throw Error("搜索关键字不能为空");let t=u(),r="".concat(t,"/api/v2/search/episodes?anime=").concat(encodeURIComponent(e));try{let e=await fetch(r);if(!e.ok)throw Error("HTTP error! Status: ".concat(e.status));let t=await e.json();if(!t.success||0!==t.errorCode)throw Error(t.errorMessage||"搜索失败");return(t.animes||[]).map(e=>{var t;return{animeId:e.animeId,animeTitle:e.animeTitle,type:e.type,typeDescription:e.typeDescription,episodeCount:(null===(t=e.episodes)||void 0===t?void 0:t.length)||0,episodes:e.episodes||[]}})}catch(e){throw console.error("搜索剧集失败:",e),Error("搜索剧集失败: ".concat(e.message))}}function h(e){if(!e)return null;let t=e.match(/第(\d+)[集话]/);if(t)return parseInt(t[1]);let r=e.match(/\d+/g);if(r&&r.length>0){let e=r.map(e=>parseInt(e)).filter(e=>e>=1&&e<=1e4);if(e.length>0){let t=Math.max(...e);if(t>=1&&t<=1e4)return t}}if(t=e.match(/(?:^|[^0-9])(\d+)(?:[集话]|$)/)){let e=parseInt(t[1]);if(e>=1&&e<=1e4)return e}return null}async function f(e,t,r){if(!e)throw Error("未选择动漫");if(t<1||t>e.episodes.length)throw Error("集数 ".concat(t," 超出范围（共 ").concat(e.episodes.length," 集）"));let n=e.episodes[t-1];if(!n)throw Error("未找到第 ".concat(t," 集的弹幕"));let a=u();return"".concat(a,"/api/v2/comment/").concat(n.episodeId.toString(),"?format=").concat("xml"===r||"json"===r?r:"xml")}var g=r(4090),x=r(5941),p=r(904),v=r(4819),y=r(9477);function b(e){let{videoTitle:t,currentEpisode:r,currentEpisodeTitle:a,onSelect:s,onClose:l,isVisible:o=!1}=e,[c,u]=(0,i.useState)([]),[d,f]=(0,i.useState)(!1),[g,x]=(0,i.useState)(null),[p,b]=(0,i.useState)(null),[w,k]=(0,i.useState)(r||null),[j,N]=(0,i.useState)(""),[S,E]=(0,i.useState)(!1),[C,D]=(0,i.useState)(!1),M=(0,i.useRef)(""),R=async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.trim())try{f(!0),x(null);let r=await m(e.trim());u(r),D(!0),t&&E(!0)}catch(e){console.error("搜索弹幕选项失败:",e),x(e instanceof Error?e.message:"搜索失败"),D(!0)}finally{f(!1)}};(0,i.useEffect)(()=>{t&&t!==M.current&&(M.current=t,E(!1),D(!1),N(""))},[t]),(0,i.useEffect)(()=>{o&&t&&(S||R(t,!1))},[o,t,S]);let _=e=>{if(b(e),r&&a){let t=h(a),n=e.episodes.find(e=>e.episodeTitle===a);n||null===t||(n=e.episodes.find(e=>h(e.episodeTitle)===t)),n?k(e.episodes.indexOf(n)+1):r<=e.episodes.length?k(r):k(1)}else k(1)},T=e=>{k(e)},L=()=>{b(null),k(null)};return(0,n.jsx)("div",{className:"fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 backdrop-blur-sm",children:(0,n.jsxs)("div",{className:"relative w-full max-w-2xl max-h-[80vh] mx-4 bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[p&&(0,n.jsx)("button",{onClick:L,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors","aria-label":"返回",children:(0,n.jsx)("svg",{className:"w-5 h-5 text-gray-500 dark:text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,n.jsx)("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:p?"选择集数":"选择弹幕源"})]}),(0,n.jsx)("button",{onClick:l,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors","aria-label":"关闭",children:(0,n.jsx)(v.Z,{className:"w-5 h-5 text-gray-500 dark:text-gray-400"})})]}),(0,n.jsxs)("div",{className:"p-4 overflow-y-auto max-h-[calc(80vh-80px)]",children:[!p&&(0,n.jsx)("form",{onSubmit:e=>{null==e||e.preventDefault(),j.trim()&&R(j,!0)},className:"mb-4",children:(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)(y.Z,{className:"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400 dark:text-gray-500"}),(0,n.jsx)("input",{type:"text",value:j,onChange:e=>N(e.target.value),placeholder:t?"自动搜索: ".concat(t," (可输入其他关键词)"):"输入关键词搜索弹幕源...",className:"w-full h-12 pl-10 pr-20 rounded-lg bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"}),(0,n.jsx)("button",{type:"submit",disabled:d||!j.trim(),className:"absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed transition-colors text-sm font-medium",children:"搜索"})]})}),d&&(0,n.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"}),(0,n.jsx)("span",{className:"ml-3 text-gray-600 dark:text-gray-400",children:"搜索中..."})]}),g&&(0,n.jsx)("div",{className:"py-8 text-center",children:(0,n.jsx)("p",{className:"text-red-500 dark:text-red-400",children:g})}),!d&&!g&&0===c.length&&C&&(0,n.jsx)("div",{className:"py-8 text-center",children:(0,n.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:"未找到匹配的弹幕源"})}),!d&&!g&&!p&&c.length>0&&(0,n.jsx)("div",{className:"space-y-2",children:c.map(e=>(0,n.jsx)("button",{onClick:()=>_(e),className:"w-full text-left p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:border-green-500 dark:hover:border-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 transition-all",children:(0,n.jsx)("div",{className:"flex items-start justify-between",children:(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsx)("h4",{className:"font-medium text-gray-900 dark:text-gray-100 mb-1",children:e.animeTitle}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[(0,n.jsx)("span",{className:"px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded",children:e.typeDescription}),(0,n.jsxs)("span",{children:["共",e.episodeCount,"集"]})]})]})})},e.animeId))}),p&&(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[(0,n.jsx)("h4",{className:"font-medium text-gray-900 dark:text-gray-100 mb-1",children:p.animeTitle}),(0,n.jsxs)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["共 ",p.episodes.length," 集"]})]}),(0,n.jsx)("div",{className:"grid grid-cols-4 sm:grid-cols-6 gap-2 max-h-[400px] overflow-y-auto",children:p.episodes.map((e,t)=>{let r=t+1,a=w===r;return(0,n.jsx)("button",{onClick:()=>T(r),className:"p-3 text-sm font-medium rounded-lg transition-all ".concat(a?"bg-green-500 text-white shadow-lg":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"),children:e.episodeTitle||"第".concat(r,"集")},e.episodeId)})}),(0,n.jsxs)("div",{className:"flex gap-2 pt-2 border-t border-gray-200 dark:border-gray-700",children:[(0,n.jsx)("button",{onClick:L,className:"flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors",children:"返回"}),(0,n.jsx)("button",{onClick:()=>{if(p&&w){let e=p.episodes[w-1];s(p,w,(null==e?void 0:e.episodeTitle)||""),l()}},disabled:!w,className:"flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed transition-colors",children:"确认"})]})]})]})]})})}var w=e=>{let{totalEpisodes:t,episodes_titles:r,episodesPerPage:a=50,value:s=1,onChange:l,onSourceChange:c,currentSource:u,currentId:d,videoTitle:m,availableSources:h=[],sourceSearchLoading:f=!1,sourceSearchError:g=null,precomputedVideoInfo:p,preferBestSource:v,setLoading:y,setIsVideoLoading:b,setVideoLoadingStage:w}=e,k=(0,o.useRouter)(),j=Math.ceil(t/a),[N,S]=(0,i.useState)(new Map),[E,C]=(0,i.useState)(new Set),D=(0,i.useRef)(new Set),M=(0,i.useRef)(new Map);(0,i.useEffect)(()=>{D.current=E},[E]),(0,i.useEffect)(()=>{M.current=N},[N]);let[R,_]=(0,i.useState)(t>1?"episodes":"sources"),[T,L]=(0,i.useState)(Math.floor((s-1)/a)),[I,P]=(0,i.useState)(!1),[A,O]=(0,i.useState)(!1),B=(0,i.useRef)(!1),U=(0,i.useMemo)(()=>I?j-1-T:T,[T,I,j]),Z=(0,i.useCallback)(async e=>{let t="".concat(e.source,"-").concat(e.id);if(D.current.has(t)||!e.episodes||0===e.episodes.length)return;let r=e.episodes.length>1?e.episodes[1]:e.episodes[0];C(e=>new Set(e).add(t));try{let e=await (0,x.e9)(r);S(r=>new Map(r).set(t,e))}catch(e){S(e=>new Map(e).set(t,{quality:"错误",loadSpeed:"未知",pingTime:0,hasError:!0}))}},[]);(0,i.useEffect)(()=>{p&&p.size>0&&(S(e=>{let t=new Map(e);return p.forEach((e,r)=>{t.set(r,e)}),t}),C(e=>{let t=new Set(e);return p.forEach((e,r)=>{e.hasError||t.add(r)}),t}),p.forEach((e,t)=>{e.hasError||D.current.add(t)}))},[p]);let[F]=(0,i.useState)(()=>{{let e=localStorage.getItem("enableOptimization");if(null!==e)try{return JSON.parse(e)}catch(e){}}return!0});(0,i.useEffect)(()=>{(async()=>{if(!F||"sources"!==R||0===h.length)return;let e=h.filter(e=>{let t="".concat(e.source,"-").concat(e.id);return!D.current.has(t)});if(0===e.length)return;let t=Math.ceil(e.length/2);for(let r=0;r<e.length;r+=t){let n=e.slice(r,r+t);await Promise.all(n.map(Z))}})()},[R,h,Z,F]);let z=(0,i.useMemo)(()=>Array.from({length:j},(e,r)=>{let n=r*a+1,s=Math.min(n+a-1,t);return{start:n,end:s}}),[j,a,t]),W=(0,i.useMemo)(()=>I?[...z].reverse().map(e=>{let{start:t,end:r}=e;return"".concat(r,"-").concat(t)}):z.map(e=>{let{start:t,end:r}=e;return"".concat(t,"-").concat(r)}),[z,I]),V=(0,i.useRef)(null),G=(0,i.useRef)([]);(0,i.useEffect)(()=>{let e=G.current[U],t=V.current;if(e&&t){let r=t.getBoundingClientRect(),n=e.getBoundingClientRect(),a=t.scrollLeft,s=n.left-r.left+a,l=n.width,o=r.width;t.scrollTo({left:s-(o-l)/2,behavior:"smooth"})}},[U,j]);let J=(0,i.useCallback)(e=>{I?L(j-1-e):L(e)},[I,j]),H=(0,i.useCallback)(e=>{null==l||l(e)},[l]),Y=(0,i.useCallback)(e=>{e&&e.source&&e.id&&(null==c||c(e.source,e.id,e.title||e.source_name||""))},[c]),q=T*a+1,K=Math.min(q+a-1,t);return(0,n.jsxs)("div",{className:"px-4 py-0 h-full bg-black/10 dark:bg-white/5 flex flex-col border-t border-b md:border-r border-white/0 dark:border-white/30 overflow-hidden",children:[(0,n.jsxs)("div",{className:"flex mb-1 -mx-6 flex-shrink-0",children:[t>1&&(0,n.jsx)("div",{onClick:()=>_("episodes"),className:"flex-1 py-3 px-6 text-center cursor-pointer transition-all duration-200 font-medium\n              ".concat("episodes"===R?"text-green-600 dark:text-green-400":"text-gray-700 hover:text-green-600 bg-black/5 dark:bg-white/5 dark:text-gray-300 dark:hover:text-green-400 hover:bg-black/3 dark:hover:bg-white/3","\n            ").trim(),children:"选集"}),(0,n.jsxs)("div",{onClick:()=>{_("sources")},className:"flex-1 py-3 px-6 text-center cursor-pointer transition-all duration-200 font-medium flex items-center justify-center\n            ".concat("sources"===R?"text-green-600 dark:text-green-400":"text-gray-700 hover:text-green-600 bg-black/5 dark:bg-white/5 dark:text-gray-300 dark:hover:text-green-400 hover:bg-black/3 dark:hover:bg-white/3","\n          ").trim(),children:[(0,n.jsx)("span",{children:"换源"}),v&&h&&h.length>0&&(0,n.jsx)("div",{onClick:e=>{e.stopPropagation(),!A&&h&&0!==h.length&&(B.current=!1,O(!0),v(h,()=>B.current).then(e=>{!B.current&&e&&(e.source!==u||e.id!==d)&&Y(e)}).catch(e=>{}).finally(()=>{!B.current&&(O(!1),y&&y(!1)),B.current=!1}))},className:"ml-2 bg-blue-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center shadow-md transition-all duration-300 ease-out ".concat(A?"opacity-50 cursor-not-allowed":"hover:bg-blue-600 hover:scale-110 cursor-pointer"),title:A?"优选进行中...":"优选播放源",children:(0,n.jsx)("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,n.jsx)("path",{d:"M13 2L3 14h9l-1 8 10-12h-9l1-8z"})})})]})]}),"episodes"===R&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"flex items-center gap-4 mb-4 border-b border-gray-300 dark:border-gray-700 -mx-6 px-6 flex-shrink-0",children:[(0,n.jsx)("div",{className:"flex-1 overflow-x-auto scrollbar-hide",ref:V,children:(0,n.jsx)("div",{className:"flex gap-2 min-w-max",children:W.map((e,t)=>{let r=t===U;return(0,n.jsxs)("button",{ref:e=>{G.current[t]=e},onClick:()=>J(t),className:"w-20 relative py-2 text-sm font-medium transition-colors whitespace-nowrap flex-shrink-0 text-center \n                        ".concat(r?"text-green-500 dark:text-green-400":"text-gray-700 hover:text-green-600 dark:text-gray-300 dark:hover:text-green-400","\n                      ").trim(),children:[e,r&&(0,n.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-0.5 bg-green-500 dark:bg-green-400"})]},e)})})}),(0,n.jsx)("button",{className:"flex-shrink-0 w-8 h-8 rounded-md flex items-center justify-center text-gray-700 hover:text-green-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:text-green-400 dark:hover:bg-white/20 transition-colors transform translate-y-[-4px]",onClick:()=>{P(e=>!e)},children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"})})})]}),(0,n.jsx)("div",{className:"overflow-y-auto flex-1 pb-4 scrollbar-hide",children:(0,n.jsx)("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:Array.from({length:K-q+1},(e,t)=>I?K-t:q+t).map(e=>{let t=e===s;return(0,n.jsx)("button",{onClick:()=>H(e-1),className:"h-9 px-1 py-1 flex items-center justify-center text-xs font-medium rounded transition-all duration-200 whitespace-nowrap font-mono\n                      ".concat(t?"bg-green-500 text-white shadow-lg shadow-green-500/25 dark:bg-green-600":"bg-gray-200 text-gray-700 hover:bg-gray-300 hover:scale-105 dark:bg-white/10 dark:text-gray-300 dark:hover:bg-white/20").trim(),children:(()=>{let t=null==r?void 0:r[e-1];if(!t)return e;let n=t.match(/第(\d+)集/);return n?n[1]:t})()},e)})})})]}),"sources"===R&&(0,n.jsxs)("div",{className:"flex flex-col h-full mt-4",children:[f&&(0,n.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"}),(0,n.jsx)("span",{className:"ml-2 text-sm text-gray-600 dark:text-gray-300",children:"搜索中..."})]}),A&&(0,n.jsxs)("div",{className:"flex items-center justify-center py-3",children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"}),(0,n.jsx)("span",{className:"ml-2 text-sm text-gray-600 dark:text-gray-300",children:"优选播放源中..."})]}),(0,n.jsx)("button",{onClick:()=>{B.current=!0,O(!1),y&&y(!1)},className:"ml-4 text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 px-2 py-1 rounded border border-red-300 dark:border-red-700 hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors",children:"取消"})]}),g&&(0,n.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"text-red-500 text-2xl mb-2",children:"⚠️"}),(0,n.jsx)("p",{className:"text-sm text-red-600 dark:text-red-400",children:g})]})}),!f&&!g&&0===h.length&&(0,n.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"text-gray-400 text-2xl mb-2",children:"\uD83D\uDCFA"}),(0,n.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:"暂无可用的换源"})]})}),!f&&!g&&h.length>0&&(0,n.jsxs)("div",{className:"flex-1 overflow-y-auto space-y-2 pb-20 scrollbar-hide",children:[h.sort((e,t)=>{var r,n,a,s;let l=(null===(r=e.source)||void 0===r?void 0:r.toString())===(null==u?void 0:u.toString())&&(null===(n=e.id)||void 0===n?void 0:n.toString())===(null==d?void 0:d.toString()),o=(null===(a=t.source)||void 0===a?void 0:a.toString())===(null==u?void 0:u.toString())&&(null===(s=t.id)||void 0===s?void 0:s.toString())===(null==d?void 0:d.toString());return l&&!o?-1:!l&&o?1:0}).map((e,t)=>{var r,a;let s=(null===(r=e.source)||void 0===r?void 0:r.toString())===(null==u?void 0:u.toString())&&(null===(a=e.id)||void 0===a?void 0:a.toString())===(null==d?void 0:d.toString());return(0,n.jsxs)("div",{onClick:()=>!s&&Y(e),className:"flex items-start gap-3 px-2 py-3 rounded-lg transition-all select-none duration-200 relative\n                      ".concat(s?"bg-green-500/10 dark:bg-green-500/20 border-green-500/30 border":"hover:bg-gray-200/50 dark:hover:bg-white/10 hover:scale-[1.02] cursor-pointer").trim(),children:[(0,n.jsx)("div",{className:"flex-shrink-0 w-12 h-20 bg-gray-300 dark:bg-gray-600 rounded overflow-hidden",children:e.episodes&&e.episodes.length>0&&(0,n.jsx)("img",{src:(0,x.a8)(e.poster),alt:e.title,className:"w-full h-full object-cover",onError:e=>{e.target.style.display="none"}})}),(0,n.jsxs)("div",{className:"flex-1 min-w-0 flex flex-col justify-between h-20",children:[(0,n.jsxs)("div",{className:"flex items-start justify-between gap-3 h-6",children:[(0,n.jsxs)("div",{className:"flex-1 min-w-0 relative group/title",children:[(0,n.jsx)("h3",{className:"font-medium text-base truncate text-gray-900 dark:text-gray-100 leading-none",children:e.title}),0!==t&&(0,n.jsxs)("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 invisible group-hover/title:opacity-100 group-hover/title:visible transition-all duration-200 ease-out delay-100 whitespace-nowrap z-[500] pointer-events-none",children:[e.title,(0,n.jsx)("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"})]})]}),(()=>{let t="".concat(e.source,"-").concat(e.id),r=N.get(t);if(r&&"未知"!==r.quality){if(r.hasError)return(0,n.jsx)("div",{className:"bg-gray-500/10 dark:bg-gray-400/20 text-red-600 dark:text-red-400 px-1.5 py-0 rounded text-xs flex-shrink-0 min-w-[50px] text-center",children:"检测失败"});{let e=["4K","2K"].includes(r.quality),t=["1080p","720p"].includes(r.quality);return(0,n.jsx)("div",{className:"bg-gray-500/10 dark:bg-gray-400/20 ".concat(e?"text-purple-600 dark:text-purple-400":t?"text-green-600 dark:text-green-400":"text-yellow-600 dark:text-yellow-400"," px-1.5 py-0 rounded text-xs flex-shrink-0 min-w-[50px] text-center"),children:r.quality})}}return null})()]}),(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("span",{className:"text-xs px-2 py-1 border border-gray-500/60 rounded text-gray-700 dark:text-gray-300",children:e.source_name}),e.episodes.length>1&&(0,n.jsxs)("span",{className:"text-xs text-gray-500 dark:text-gray-400 font-medium",children:[e.episodes.length," 集"]})]}),(0,n.jsx)("div",{className:"flex items-end h-6",children:(()=>{let t="".concat(e.source,"-").concat(e.id),r=N.get(t);if(r)return r.hasError?(0,n.jsx)("div",{className:"text-red-500/90 dark:text-red-400 font-medium text-xs",children:"无测速数据"}):(0,n.jsxs)("div",{className:"flex items-end gap-3 text-xs",children:[(0,n.jsx)("div",{className:"text-green-600 dark:text-green-400 font-medium text-xs",children:r.loadSpeed}),(0,n.jsxs)("div",{className:"text-orange-600 dark:text-orange-400 font-medium text-xs",children:[r.pingTime,"ms"]})]})})()})]})]},"".concat(e.source,"-").concat(e.id))}),(0,n.jsx)("div",{className:"flex-shrink-0 mt-auto pt-2 border-t border-gray-400 dark:border-gray-700",children:(0,n.jsx)("button",{onClick:()=>{m&&k.push("/search?q=".concat(encodeURIComponent(m)))},className:"w-full text-center text-xs text-gray-500 dark:text-gray-400 hover:text-green-500 dark:hover:text-green-400 transition-colors py-2",children:"影片匹配有误？点击去搜索"})})]})]})]})},k=r(3593),j=r(5036),N=r(1816);function S(){var e,t,l,c;let u=(0,o.useRouter)(),m=(0,o.useSearchParams)(),[v,y]=(0,i.useState)(!0),[S,C]=(0,i.useState)("searching"),[D,M]=(0,i.useState)("正在搜索播放源..."),[R,_]=(0,i.useState)(null),[T,L]=(0,i.useState)(null),[I,P]=(0,i.useState)(!1),[A,O]=(0,i.useState)(!1),[B,U]=(0,i.useState)(!1),[Z,F]=(0,i.useState)(!1),[z,W]=(0,i.useState)({enable:!1,intro_time:0,outro_time:0}),V=(0,i.useRef)(z);(0,i.useEffect)(()=>{V.current=z},[z,z.enable,z.intro_time,z.outro_time]);let G=(0,i.useRef)(0),[J,H]=(0,i.useState)(!1),[Y,q]=(0,i.useState)(()=>{{let e=localStorage.getItem("enable_blockad");if(null!==e)return"true"===e}return!0}),K=(0,i.useRef)(Y);(0,i.useEffect)(()=>{K.current=Y},[Y]);let[X,Q]=(0,i.useState)(null),[$,ee]=(0,i.useState)(null),[et,er]=(0,i.useState)(void 0),[en,ea]=(0,i.useState)(!1),es=(0,i.useRef)(null),el=(0,i.useRef)(null);(0,i.useEffect)(()=>{es.current=X},[X]);let[eo,ei]=(0,i.useState)(m.get("title")||""),[ec,eu]=(0,i.useState)(m.get("year")||""),[ed,em]=(0,i.useState)(""),[eh,ef]=(0,i.useState)(0),[eg,ex]=(0,i.useState)(m.get("source")||""),[ep,ev]=(0,i.useState)(m.get("id")||""),[ey]=(0,i.useState)(m.get("stitle")||""),[eb]=(0,i.useState)(m.get("stype")||""),[ew,ek]=(0,i.useState)(0),[ej,eN]=(0,i.useState)(!1),[eS,eE]=(0,i.useState)("bilibili1"),[eC,eD]=(0,i.useState)(""),[eM,eR]=(0,i.useState)(!1);(0,i.useEffect)(()=>{let e=localStorage.getItem("autoDanmakuEnabled");null!==e&&eN(JSON.parse(e));let t=localStorage.getItem("preferredDanmakuPlatform");t&&eE(t)},[]);let[e_,eT]=(0,i.useState)("loading");if((0,i.useEffect)(()=>{(async()=>{var e;if((null===(e=window.RUNTIME_CONFIG)||void 0===e?void 0:e.STORAGE_TYPE)==="localstorage"){eT("active");return}try{let e=await fetch("/api/user/subscription");if(e.ok){let t=await e.json();"active"===t.status||"trial"===t.status?eT("active"):eT("inactive")}else eT("inactive")}catch(e){console.error("Failed to check subscription:",e),eT("inactive")}})()},[]),"inactive"===e_)return(0,n.jsx)(j.Z,{children:(0,n.jsx)("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:(0,n.jsxs)("div",{className:"bg-gray-100 dark:bg-gray-900 p-8 rounded-2xl shadow-xl max-w-md w-full",children:[(0,n.jsx)(a.Z,{className:"w-16 h-16 mx-auto mb-6 text-yellow-500"}),(0,n.jsx)("h1",{className:"text-2xl font-bold mb-4 text-gray-900 dark:text-white",children:"本片仅限 VIP 会员观看"}),(0,n.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-8",children:"开通会员即可解锁所有海量高清影视内容，享受无广告流畅体验。"}),(0,n.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,n.jsx)("button",{onClick:()=>u.push("/vip"),className:"w-full py-3 px-6 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5",children:"立即开通会员"}),(0,n.jsx)("button",{onClick:()=>u.push("/"),className:"w-full py-3 px-6 bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium rounded-xl hover:bg-gray-300 dark:hover:bg-gray-700 transition",children:"返回首页"})]})]})})});if("loading"===e_)return(0,n.jsx)(j.Z,{children:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-[60vh]",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500"})})});let eL=(0,i.useRef)(eg),eI=(0,i.useRef)(ep),eP=(0,i.useRef)(eo),eA=(0,i.useRef)(ec),eO=(0,i.useRef)(T),eB=(0,i.useRef)(ew);(0,i.useEffect)(()=>{var e;if(!$||!T||!(null==T?void 0:null===(e=T.episodes_titles)||void 0===e?void 0:e[ew]))return;let t=null;if(void 0!==et&&eM?(t=$.episodes[et-1],eR(!1)):ej&&(t=$.episodes[0]),!t)return;let r=$.episodes.indexOf(t)+1;setTimeout(()=>{e7.current&&e7.current.setting.update({name:"弹幕源",tooltip:t.episodeTitle})},100),(async()=>{try{let e=await f($,r,"xml");te.current&&e!==tt.current&&(console.log("动态更新弹幕源:",e),te.current.config({danmuku:e}),te.current.load(),tt.current=e,eD(t.episodeTitle))}catch(e){console.error("获取弹幕 URL 失败:",e)}})()},[ew,$,et]),(0,i.useEffect)(()=>{eL.current=eg,eI.current=ep,eO.current=T,eB.current=ew,eP.current=eo,eA.current=ec},[eg,ep,T,ew,eo,ec]);let[eU,eZ]=(0,i.useState)(""),eF=(null==T?void 0:null===(e=T.episodes)||void 0===e?void 0:e.length)||0,ez=(0,i.useRef)(null),eW=(0,i.useRef)(.7),eV=(0,i.useRef)(1),eG=(0,i.useRef)(!1),eJ=(0,i.useRef)(!1),eH=(0,i.useRef)({danmuku:"",speed:5,margin:[10,"25%"],opacity:1,color:"#FFFFFF",mode:0,modes:[0,1,2],fontSize:25,antiOverlap:!0,synchronousPlayback:!1,mount:void 0,heatmap:!1,width:512,points:[],filter:e=>e.text.length<=100,beforeVisible:()=>!0,visible:!0,emitter:!1,maxLength:200,lockTime:5,theme:"dark",OPACITY:{},FONT_SIZE:{},MARGIN:{},SPEED:{},COLOR:[],beforeEmit:e=>new Promise(e=>{setTimeout(()=>{e(!0)},1e3)})}),[eY,eq]=(0,i.useState)([]),[eK,eX]=(0,i.useState)(!1),[eQ,e$]=(0,i.useState)(null),[e0,e1]=(0,i.useState)(new Map),[e2,e5]=(0,i.useState)(!0),[e4,e3]=(0,i.useState)("initing"),e6=(0,i.useRef)(null),e8=(0,i.useRef)(0),e7=(0,i.useRef)(null),e9=(0,i.useRef)(null),te=(0,i.useRef)(null),tt=(0,i.useRef)(""),tr=(0,i.useRef)(null),tn=async(e,t)=>{if(1===e.length)return e[0];if(null==t?void 0:t())throw Error("优选已取消");let r=Math.ceil(e.length/2),n=[];for(let a=0;a<e.length;a+=r){if(null==t?void 0:t())throw Error("优选已取消");let s=e.slice(a,a+r),l=await Promise.all(s.map(async e=>{try{if(!e.episodes||0===e.episodes.length)return console.warn("播放源 ".concat(e.source_name," 没有可用的播放地址")),null;let t=e.episodes.length>1?e.episodes[1]:e.episodes[0],r=await (0,x.e9)(t);return{source:e,testResult:r}}catch(e){return null}}));n.push(...l)}let a=new Map;n.forEach((t,r)=>{let n=e[r],s="".concat(n.source,"-").concat(n.id);t&&a.set(s,t.testResult)});let s=n.filter(Boolean);if(null==t?void 0:t())throw Error("优选已取消");if(e1(a),0===s.length)return console.warn("所有播放源测速都失败，使用第一个播放源"),eq(e),e[0];let l=s.map(e=>{let t=e.testResult.loadSpeed;if("未知"===t||"测量中..."===t)return 0;let r=t.match(/^([\d.]+)\s*(KB\/s|MB\/s)$/);if(!r)return 0;let n=parseFloat(r[1]);return"MB/s"===r[2]?1024*n:n}).filter(e=>e>0),o=l.length>0?Math.max(...l):1024,i=s.map(e=>e.testResult.pingTime).filter(e=>e>0),c=i.length>0?Math.min(...i):50,u=i.length>0?Math.max(...i):1e3,d=s.map(e=>({...e,score:ta(e.testResult,o,c,u)}));d.sort((e,t)=>t.score-e.score);let m=new Map;d.forEach(e=>{let t="".concat(e.source.source,"-").concat(e.source.id);m.set(t,e.score)});let h=e.map((e,t)=>{var r;let n="".concat(e.source,"-").concat(e.id);return{source:e,score:null!==(r=m.get(n))&&void 0!==r?r:-1,index:t}});h.sort((e,t)=>e.score!==t.score?t.score-e.score:e.index-t.index);let f=h.map(e=>e.source);if(null==t?void 0:t())throw Error("优选已取消");return eq(f),d[0].source},ta=(e,t,r,n)=>{let a;return Math.round(100*(0+.4*(()=>{switch(e.quality){case"4K":return 100;case"2K":return 85;case"1080p":return 75;case"720p":return 60;case"480p":return 40;case"SD":return 20;default:return 0}})()+.4*(()=>{let r=e.loadSpeed;if("未知"===r||"测量中..."===r)return 30;let n=r.match(/^([\d.]+)\s*(KB\/s|MB\/s)$/);if(!n)return 30;let a=parseFloat(n[1]);return Math.min(100,Math.max(0,("MB/s"===n[2]?1024*a:a)/t*100))})()+.2*(()=>{let t=e.pingTime;return t<=0?0:n===r?100:Math.min(100,Math.max(0,(n-t)/(n-r)*100))})()))/100},ts=(e,t)=>{if(!e||!e.episodes||t>=e.episodes.length){eZ("");return}let r=(null==e?void 0:e.episodes[t])||"";r!==eU&&eZ(r)},tl=(e,t)=>{if(!e||!t)return;let r=Array.from(e.getElementsByTagName("source"));if(!r.some(e=>e.src===t)){r.forEach(e=>e.remove());let n=document.createElement("source");n.src=t,e.appendChild(n)}e.disableRemotePlayback=!1,e.hasAttribute("disableRemotePlayback")&&e.removeAttribute("disableRemotePlayback")},to=async()=>{try{if(document.hidden){console.log("页面不可见，跳过 Wake Lock 请求");return}"wakeLock"in navigator&&(tr.current=await navigator.wakeLock.request("screen"),console.log("Wake Lock 已启用"))}catch(e){console.warn("Wake Lock 请求失败:",e)}},ti=async()=>{try{tr.current&&(await tr.current.release(),tr.current=null,console.log("Wake Lock 已释放"))}catch(e){console.warn("Wake Lock 释放失败:",e)}},tc=()=>{if(e7.current)try{if(eG.current=!!e7.current.fullscreen,eJ.current=!!e7.current.fullscreenWeb,te.current){let e=te.current;if(e.option){let t={...e.option};"mount"in t&&(t.mount=void 0),"danmuku"in t&&(t.danmuku=""),eH.current=t}else"boolean"==typeof e.visible&&(eH.current.visible=e.visible)}e7.current.video&&e7.current.video.hls&&e7.current.video.hls.destroy(),e7.current.destroy(),e7.current=null,console.log("播放器资源已清理")}catch(e){console.warn("清理播放器资源时出错:",e),e7.current=null}},tu=async e=>{if(eL.current&&eI.current)try{W(e),e.enable||e.intro_time||e.outro_time?await (0,g.C2)(eL.current,eI.current,e):(await (0,g.Lj)(eL.current,eI.current),e7.current.setting.update({name:"跳过片头片尾",html:"跳过片头片尾",switch:V.current.enable,onSwitch:function(e){let t={...V.current,enable:!e.switch};return tu(t),!e.switch}}),e7.current.setting.update({name:"设置片头",html:"设置片头",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="5" cy="12" r="2" fill="#ffffff"/><path d="M9 12L17 12" stroke="#ffffff" stroke-width="2"/><path d="M17 6L17 18" stroke="#ffffff" stroke-width="2"/></svg>',tooltip:0===V.current.intro_time?"设置片头时间":"".concat(td(V.current.intro_time)),onClick:function(){var e;let t=(null===(e=e7.current)||void 0===e?void 0:e.currentTime)||0;if(t>0){let e={...V.current,intro_time:t};return tu(e),"".concat(td(t))}}}),e7.current.setting.update({name:"设置片尾",html:"设置片尾",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 6L7 18" stroke="#ffffff" stroke-width="2"/><path d="M7 12L15 12" stroke="#ffffff" stroke-width="2"/><circle cx="19" cy="12" r="2" fill="#ffffff"/></svg>',tooltip:V.current.outro_time>=0?"设置片尾时间":"-".concat(td(-V.current.outro_time)),onClick:function(){var e,t;let r=-((null===(e=e7.current)||void 0===e?void 0:e.duration)-(null===(t=e7.current)||void 0===t?void 0:t.currentTime))||0;if(r<0){let e={...V.current,outro_time:r};return tu(e),"-".concat(td(-r))}}})),console.log("跳过片头片尾配置已保存:",e)}catch(e){console.error("保存跳过片头片尾配置失败:",e)}},td=e=>{if(0===e)return"00:00";let t=Math.floor(e/3600),r=Math.floor(e%3600/60),n=Math.round(e%60);return 0===t?"".concat(r.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0")):"".concat(t.toString().padStart(2,"0"),":").concat(r.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0"))};(0,i.useEffect)(()=>{ts(T,ew)},[T,ew]),(0,i.useEffect)(()=>{let e=async(e,t)=>{eX(!0),e$("");let r=[];try{var n;let a=(0,x.Jy)(),s=await fetch("/api/search?q=".concat(encodeURIComponent(e.trim()),"&timeout=").concat(a,"&stream=1"));if(!s.ok)throw Error("搜索失败");let l=null===(n=s.body)||void 0===n?void 0:n.getReader();if(!l)throw Error("无法读取搜索流");let o=new TextDecoder,i="",c=!1;for(;!c;){let{value:e,done:n}=await l.read();if(c=n,e){let n=(i+=o.decode(e,{stream:!0})).split("\n");for(let e of(i=n.pop()||"",n))if(e.trim())try{let n=JSON.parse(e);if(n.pageResults){let e=n.pageResults.filter(e=>{let t=e.title.trim().replace(/\s+/g," ").toLowerCase()===eP.current.trim().replace(/\s+/g," ").toLowerCase(),r=!eA.current||e.year.toLowerCase()===eA.current.toLowerCase(),n=!eb||"tv"===eb&&e.episodes.length>1||"movie"===eb&&1===e.episodes.length;return t&&r&&n});if(e.length>0){let n=e.filter(e=>!r.some(t=>t.source===e.source&&t.id===e.id));n.length>0&&(r.push(...n),eq([...r]),eX(!1),null==t||t(n))}}}catch(e){console.warn("解析行 JSON 失败:",e)}}}return eX(!1),r}catch(e){return e$(e instanceof Error?e.message:"搜索失败"),eq([]),[]}};function t(e){ex(e.source),ev(e.id),eu(e.year),ei(e.title||eP.current),em(e.poster),ef(e.douban_id||0),L(e),ew>=e.episodes.length&&ek(0);let t=new URL(window.location.href);t.searchParams.set("source",e.source),t.searchParams.set("id",e.id),t.searchParams.set("year",e.year),t.searchParams.set("title",e.title),t.searchParams.delete("prefer"),window.history.replaceState({},"",t.toString()),C("ready"),M("✨ 准备就绪，即将开始播放..."),setTimeout(()=>y(!1),500)}(async()=>{if(!eg&&!ep&&!eo&&!ey){_("缺少必要参数"),y(!1);return}y(!0),C(eg&&ep?"fetching":"searching"),M(eg&&ep?"\uD83C\uDFAC 正在获取视频详情...":"\uD83D\uDD0D 正在搜索播放源...");let r=(()=>{let e=localStorage.getItem("enablePreferBestSource");if(null===e)return!1;try{return JSON.parse(e)}catch(e){return!1}})(),n=null,a=[],s=!1;if(await e(eo,e=>{if(a=[...a,...e],!n&&eg&&ep){let a=e.find(e=>e.source===eg&&e.id===ep);a&&(n=a,r||(t(n),s=!0))}}),!n&&a.length>0&&(n=a[0]),!n){_("未找到匹配结果"),y(!1);return}if(r&&a.length>1){C("preferring"),M("\uD83D\uDE80 正在优选播放源...");try{n=await tn(a)}catch(e){console.error("优选播放源失败:",e)}}s||t(n)})()},[]),(0,i.useEffect)(()=>{if(I&&J){te.current.config({danmuku:tt.current}),te.current.load(),H(!1);return}if(!ej||!T||!I)return;el.current&&el.current.abort();let e=new AbortController;el.current=e;let t=3;try{let e=localStorage.getItem("danmakuRetryCount");if(null!==e){let r=parseInt(e,10);isNaN(r)||(t=r)}}catch(e){}let r=0,n=!1;return(async()=>{for(O(!0);!n&&(-1===t||r<=t);){r++;try{var a;let s=eP.current,l=null==T?void 0:null===(a=T.episodes_titles)||void 0===a?void 0:a[ew];if(!l)throw Error("无法获取当前集数标题（episodes_titles 无效）");let o=h(l);o||(o=ew+1);let i=function(e){if(!e)return 1;let t=(e=e.toLowerCase()).match(/(?:season|s)\s*?(\d{1,2})/i);if(t&&t[1])return Number(t[1]);let r=e.match(/第\s*(\d+)\s*季/);return r&&r[1]?Number(r[1]):1}(s),c="".concat(s," S").concat(i,"E").concat(o," @").concat(eS),u=await d(c,e.signal);if(console.log("自动弹幕匹配尝试第".concat(r,"次:"),u),e.signal.aborted)return;if(u.length>0){let e=u[0],t={animeId:e.animeId,animeTitle:e.animeTitle,type:e.type,typeDescription:e.typeDescription,episodeCount:1,episodes:[{episodeId:e.episodeId,episodeTitle:e.episodeTitle}]};ee(t),Q(eS),n=!0;break}(-1===t||r<=t)&&await new Promise(e=>setTimeout(e,1500))}catch(e){if(e instanceof DOMException&&"AbortError"===e.name){console.log("自动加载弹幕已取消");return}console.error("自动弹幕匹配第".concat(r,"次失败:"),e),(-1===t||r<=t)&&await new Promise(e=>setTimeout(e,1500))}}n||(0,k.p)("自动加载弹幕失败，请手动选择弹幕源"),e.signal.aborted||O(!1)})(),()=>{el.current&&(el.current.abort(),el.current=null)}},[ew,ej,I,eS]),(0,i.useEffect)(()=>{(async()=>{if(eg&&ep)try{let e=(await (0,g.Rr)())[(0,g.sO)(eg,ep)];if(e){let t=e.index-1,r=e.play_time;t!==ew&&ek(t),ez.current=r}}catch(e){console.error("读取播放记录失败:",e)}})()},[]),(0,i.useEffect)(()=>{(async()=>{if(eg&&ep)try{let e=await (0,g.bP)(eg,ep);e&&W(e)}catch(e){console.error("读取跳过片头片尾配置失败:",e)}})()},[]);let tm=async(e,t,r)=>{try{var n;e3("sourceChanging"),e5(!0);let a=(null===(n=e7.current)||void 0===n?void 0:n.currentTime)||0;if(console.log("换源前当前播放时间:",a),eL.current&&eI.current)try{await (0,g.Ji)(eL.current,eI.current),console.log("已清除前一个播放记录")}catch(e){console.error("清除播放记录失败:",e)}if(eL.current&&eI.current)try{await (0,g.Lj)(eL.current,eI.current),await (0,g.C2)(e,t,V.current)}catch(e){console.error("清除跳过片头片尾配置失败:",e)}let s=eY.find(r=>r.source===e&&r.id===t);if(!s){_("未找到匹配结果");return}let l=ew;(!s.episodes||l>=s.episodes.length)&&(l=0),l!==ew?ez.current=0:(!ez.current||0===ez.current)&&a>1&&(ez.current=a);let o=new URL(window.location.href);o.searchParams.set("source",e),o.searchParams.set("id",t),o.searchParams.set("year",s.year),window.history.replaceState({},"",o.toString()),ei(s.title||r),eu(s.year),em(s.poster),ef(s.douban_id||0),ex(e),ev(t),L(s),ek(l),setTimeout(()=>{e5(!1)},100)}catch(e){e5(!1),_(e instanceof Error?e.message:"换源失败")}};(0,i.useEffect)(()=>(document.addEventListener("keydown",tx),()=>{document.removeEventListener("keydown",tx)}),[]);let th=async e=>{if(e!==eB.current&&e>=0&&e<eF){e7.current&&e7.current.paused&&tp(),e7.current&&(tc(),P(!1),eD(""));try{let t=(await (0,g.Rr)())[(0,g.sO)(eL.current,eI.current)];t&&t.index-1===e&&t.play_time>0?ez.current=t.play_time:ez.current=0}catch(e){ez.current=0}ek(e)}},tf=()=>{let e=eO.current,t=eB.current;e&&e.episodes&&t>0&&(e7.current&&!e7.current.paused&&tp(),e7.current&&(tc(),P(!1),eD("")),ek(t-1))},tg=()=>{let e=eO.current,t=eB.current;e&&e.episodes&&t<e.episodes.length-1&&(e7.current&&!e7.current.paused&&tp(),e7.current&&(tc(),P(!1),eD("")),ek(t+1))},tx=e=>{if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName){if(e.altKey&&"ArrowLeft"===e.key&&eO.current&&eB.current>0&&(tf(),e.preventDefault()),e.altKey&&"ArrowRight"===e.key){let t=eO.current,r=eB.current;t&&r<t.episodes.length-1&&(tg(),e.preventDefault())}!e.altKey&&"ArrowLeft"===e.key&&e7.current&&e7.current.currentTime>5&&(e7.current.currentTime-=10,e.preventDefault()),!e.altKey&&"ArrowRight"===e.key&&e7.current&&e7.current.currentTime<e7.current.duration-5&&(e7.current.currentTime+=10,e.preventDefault()),"ArrowUp"===e.key&&e7.current&&e7.current.volume<1&&(e7.current.volume=Math.round((e7.current.volume+.1)*10)/10,e7.current.notice.show="音量: ".concat(Math.round(100*e7.current.volume)),e.preventDefault()),"ArrowDown"===e.key&&e7.current&&e7.current.volume>0&&(e7.current.volume=Math.round((e7.current.volume-.1)*10)/10,e7.current.notice.show="音量: ".concat(Math.round(100*e7.current.volume)),e.preventDefault())," "===e.key&&e7.current&&(e7.current.toggle(),e.preventDefault()),("f"===e.key||"F"===e.key)&&e7.current&&(e7.current.fullscreen=!e7.current.fullscreen,e.preventDefault())}},tp=async()=>{var e,t,r,n,a,s;if(!e7.current||!eL.current||!eI.current||!eP.current||!(null===(e=eO.current)||void 0===e?void 0:e.source_name))return;let l=e7.current,o=l.currentTime||0,i=l.duration||0;if(!(o<1)&&i)try{await (0,g.c1)(eL.current,eI.current,{title:eP.current,source_name:(null===(t=eO.current)||void 0===t?void 0:t.source_name)||"",year:null===(r=eO.current)||void 0===r?void 0:r.year,cover:(null===(n=eO.current)||void 0===n?void 0:n.poster)||"",index:eB.current+1,total_episodes:(null===(a=eO.current)||void 0===a?void 0:a.episodes.length)||1,play_time:Math.floor(o),total_time:Math.floor(i),save_time:Date.now(),search_title:ey}),e8.current=Date.now(),console.log("播放进度已保存:",{title:eP.current,episode:eB.current+1,year:null===(s=eO.current)||void 0===s?void 0:s.year,progress:"".concat(Math.floor(o),"/").concat(Math.floor(i))})}catch(e){console.error("保存播放进度失败:",e)}};(0,i.useEffect)(()=>{let e=()=>{tp(),ti(),tc()},t=()=>{"hidden"===document.visibilityState?(tp(),ti()):"visible"===document.visibilityState&&e7.current&&!e7.current.paused&&to()};return window.addEventListener("beforeunload",e),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("beforeunload",e),document.removeEventListener("visibilitychange",t)}},[ew,T,e7.current]),(0,i.useEffect)(()=>()=>{e6.current&&clearInterval(e6.current)},[]),(0,i.useEffect)(()=>{eg&&ep&&(async()=>{try{let e=await (0,g.at)(eg,ep);U(e)}catch(e){console.error("检查收藏状态失败:",e)}})()},[eg,ep]),(0,i.useEffect)(()=>{if(eg&&ep)return(0,g.rq)("favoritesUpdated",e=>{U(!!e[(0,g.sO)(eg,ep)])})},[eg,ep]);let tv=async()=>{if(eP.current&&eO.current&&eL.current&&eI.current)try{if(B)await (0,g.r7)(eL.current,eI.current),U(!1);else{var e,t,r,n;await (0,g.qn)(eL.current,eI.current,{title:eP.current,source_name:(null===(e=eO.current)||void 0===e?void 0:e.source_name)||"",year:null===(t=eO.current)||void 0===t?void 0:t.year,cover:(null===(r=eO.current)||void 0===r?void 0:r.poster)||"",total_episodes:(null===(n=eO.current)||void 0===n?void 0:n.episodes.length)||1,save_time:Date.now(),search_title:ey}),U(!0)}}catch(e){console.error("切换收藏失败:",e)}},ty=(0,i.useRef)(null),tb=(0,i.useRef)(null),tw=(0,i.useRef)(null),[tk,tj]=(0,i.useState)(!1);return((0,i.useEffect)(()=>{let e=!0;return(async()=>{try{let[{default:t},{default:n},{default:a}]=await Promise.all([r.e(280).then(r.bind(r,8855)),Promise.resolve().then(r.bind(r,3226)),r.e(201).then(r.bind(r,9201))]);if(!e)return;ty.current=t,tb.current=n,tw.current=a,tj(!0)}catch(e){console.error("加载播放器库失败:",e),tj(!1)}})(),()=>{e=!1}},[]),(0,i.useEffect)(()=>{var e,t;let r=ty.current,n=tb.current;if(!tk||!r||!n||!eU||v||null===ew||!e9.current)return;if(!T||!T.episodes||ew>=T.episodes.length||ew<0){_("选集索引无效，当前共 ".concat(eF," 集"));return}if(!eU){_("视频地址无效");return}console.log(eU);let a="function"==typeof window.webkitConvertPointFromNodeToPage;if(!a&&e7.current){e7.current.switch=eU,e7.current.title="".concat(eo," - 第").concat(ew+1,"集"),e7.current.poster=ed,(null===(e=e7.current)||void 0===e?void 0:e.video)&&tl(e7.current.video,eU);return}e7.current&&tc();try{r.PLAYBACK_RATE=[.5,.75,1,1.25,1.5,2,3],r.USE_RAF=!0;class e extends n.DefaultConfig.loader{constructor(e){super(e);let t=this.load.bind(this);this.load=function(e,r,n){if("manifest"===e.type||"level"===e.type){let e=n.onSuccess;n.onSuccess=function(t,r,n){return t.data&&"string"==typeof t.data&&(t.data=function(e){if(!e)return"";let t=e.split("\n"),r=[];for(let e=0;e<t.length;e++){let n=t[e];n.includes("#EXT-X-DISCONTINUITY")||r.push(n)}return r.join("\n")}(t.data)),e(t,r,n,null)}}t(e,r,n)}}}e7.current=new r({container:e9.current,url:eU,poster:ed,volume:.7,isLive:!1,muted:!1,autoplay:!0,pip:!0,autoSize:!1,autoMini:!1,screenshot:!1,setting:!0,loop:!1,flip:!1,playbackRate:!0,aspectRatio:!1,fullscreen:!0,fullscreenWeb:!0,subtitleOffset:!1,miniProgressBar:!1,mutex:!0,playsInline:!0,autoPlayback:!1,airplay:!0,theme:"#22c55e",lang:"zh-cn",hotkey:!1,fastForward:!0,autoOrientation:!0,lock:!0,moreVideoAttr:{crossOrigin:"anonymous"},plugins:[tw.current(eH.current)],customType:{m3u8:function(t,r){if(!n){console.error("HLS.js 未加载");return}t.hls&&t.hls.destroy();let a=new n({debug:!1,enableWorker:!0,lowLatencyMode:!0,maxBufferLength:30,backBufferLength:30,maxBufferSize:6e7,loader:K.current?e:n.DefaultConfig.loader});a.loadSource(r),a.attachMedia(t),t.hls=a,tl(t,r),a.on(n.Events.ERROR,function(e,t){if(console.error("HLS Error:",e,t),t.fatal)switch(t.type){case n.ErrorTypes.NETWORK_ERROR:console.log("网络错误，尝试恢复..."),a.startLoad();break;case n.ErrorTypes.MEDIA_ERROR:console.log("媒体错误，尝试恢复..."),a.recoverMediaError();break;default:console.log("无法恢复的错误"),a.destroy()}})}},icons:{loading:'<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48cGF0aCBkPSJNMjUuMjUxIDYuNDYxYy0xMC4zMTggMC0xOC42ODMgOC4zNjUtMTguNjgzIDE4LjY4M2g0LjA2OGMwLTguMDcgNi41NDUtMTQuNjE1IDE0LjYxNS0xNC42MTVWNi40NjF6IiBmaWxsPSIjMDA5Njg4Ij48YW5pbWF0ZVRyYW5zZm9ybSBhdHRyaWJ1dGVOYW1lPSJ0cmFuc2Zvcm0iIGF0dHJpYnV0ZVR5cGU9IlhNTCIgZHVyPSIxcyIgZnJvbT0iMCAyNSAyNSIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIHRvPSIzNjAgMjUgMjUiIHR5cGU9InJvdGF0ZSIvPjwvcGF0aD48L3N2Zz4=">'},settings:[{html:"去广告",icon:'<text x="50%" y="50%" font-size="20" font-weight="bold" text-anchor="middle" dominant-baseline="middle" fill="#ffffff">AD</text>',tooltip:Y?"已开启":"已关闭",onClick(){let e=!Y;try{localStorage.setItem("enable_blockad",String(e)),e7.current&&(ez.current=e7.current.currentTime,e7.current.video&&e7.current.video.hls&&e7.current.video.hls.destroy(),e7.current.destroy(),e7.current=null),q(e),P(!1),H(!0)}catch(e){}return e?"当前开启":"当前关闭"}},{name:"跳过片头片尾",html:"跳过片头片尾",switch:V.current.enable,onSwitch:function(e){let t={...V.current,enable:!e.switch};return tu(t),!e.switch}},{html:"删除跳过配置",onClick:function(){return tu({enable:!1,intro_time:0,outro_time:0}),""}},{name:"设置片头",html:"设置片头",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="5" cy="12" r="2" fill="#ffffff"/><path d="M9 12L17 12" stroke="#ffffff" stroke-width="2"/><path d="M17 6L17 18" stroke="#ffffff" stroke-width="2"/></svg>',tooltip:0===V.current.intro_time?"设置片头时间":"".concat(td(V.current.intro_time)),onClick:function(){var e;let t=(null===(e=e7.current)||void 0===e?void 0:e.currentTime)||0;if(t>0){let e={...V.current,intro_time:t};return tu(e),"".concat(td(t))}}},{name:"设置片尾",html:"设置片尾",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 6L7 18" stroke="#ffffff" stroke-width="2"/><path d="M7 12L15 12" stroke="#ffffff" stroke-width="2"/><circle cx="19" cy="12" r="2" fill="#ffffff"/></svg>',tooltip:V.current.outro_time>=0?"设置片尾时间":"-".concat(td(-V.current.outro_time)),onClick:function(){var e,t;let r=-((null===(e=e7.current)||void 0===e?void 0:e.duration)-(null===(t=e7.current)||void 0===t?void 0:t.currentTime))||0;if(r<0){let e={...V.current,outro_time:r};return tu(e),"-".concat(td(-r))}}},{name:"弹幕源",html:"弹幕源",tooltip:eC||"未选择",onClick:function(){ea(!0)}}],controls:[{position:"left",index:13,html:'<i class="art-icon flex"><svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" fill="currentColor"/></svg></i>',tooltip:"播放下一集",click:function(){tg()}}]}),e7.current.on("ready",()=>{var e,t;if(_(null),(null===(t=e7.current)||void 0===t?void 0:null===(e=t.plugins)||void 0===e?void 0:e.artplayerPluginDanmuku)&&(te.current=e7.current.plugins.artplayerPluginDanmuku,console.log("弹幕插件实例已捕获",te.current),P(!0),te.current))try{te.current.config(eH.current)}catch(e){}e7.current&&!e7.current.paused&&to();try{eJ.current&&(e7.current.fullscreenWeb=!0),eG.current&&setTimeout(()=>{e7.current.fullscreen=!0},0)}catch(e){}}),e7.current.on("play",()=>{to()}),e7.current.on("pause",()=>{ti(),tp()}),e7.current.on("video:ended",()=>{ti()}),e7.current&&!e7.current.paused&&to(),e7.current.on("video:volumechange",()=>{eW.current=e7.current.volume}),e7.current.on("video:ratechange",()=>{eV.current=e7.current.playbackRate}),e7.current.on("video:canplay",()=>{if(ez.current&&ez.current>0)try{let e=e7.current.duration||0,t=ez.current;e&&t>=e-2&&(t=Math.max(0,e-5)),e7.current.currentTime=t,console.log("成功恢复播放进度到:",ez.current)}catch(e){console.warn("恢复播放进度失败:",e)}ez.current=null,setTimeout(()=>{Math.abs(e7.current.volume-eW.current)>.01&&(e7.current.volume=eW.current),Math.abs(e7.current.playbackRate-eV.current)>.01&&a&&(e7.current.playbackRate=eV.current),e7.current.notice.show=""},0),e5(!1)}),e7.current.on("video:timeupdate",()=>{if(!V.current.enable)return;let e=e7.current.currentTime||0,t=e7.current.duration||0,r=Date.now();if(!(r-G.current<1500)&&(G.current=r,V.current.intro_time>0&&e<V.current.intro_time&&(e7.current.currentTime=V.current.intro_time,e7.current.notice.show="已跳过片头 (".concat(td(V.current.intro_time),")")),V.current.outro_time<0&&t>0&&e>e7.current.duration+V.current.outro_time)){var n,a;eB.current<((null===(a=eO.current)||void 0===a?void 0:null===(n=a.episodes)||void 0===n?void 0:n.length)||1)-1?tg():e7.current.pause(),e7.current.notice.show="已跳过片尾 (".concat(td(V.current.outro_time),")")}}),e7.current.on("error",e=>{if(console.error("播放器错误:",e),e7.current.currentTime>0)return}),e7.current.on("video:ended",()=>{let e=eO.current,t=eB.current;e&&e.episodes&&t<e.episodes.length-1&&setTimeout(()=>{tg()},1e3)}),e7.current.on("video:timeupdate",()=>{let e=Date.now(),t=5e3;"upstash"===N.env.NEXT_PUBLIC_STORAGE_TYPE&&(t=2e4),e-e8.current>t&&(tp(),e8.current=e)}),e7.current.on("pause",()=>{tp()}),(null===(t=e7.current)||void 0===t?void 0:t.video)&&tl(e7.current.video,eU)}catch(e){console.error("创建播放器失败:",e),_("播放器初始化失败")}},[tk,eU,v,Y,ew,T]),(0,i.useEffect)(()=>{let e=()=>{document.hidden||!e7.current||e7.current.paused?document.hidden&&ti():to()};return document.addEventListener("visibilitychange",e),()=>{e6.current&&clearInterval(e6.current),ti(),document.removeEventListener("visibilitychange",e),tc()}},[]),v)?(0,n.jsx)(j.Z,{activePath:"/play",children:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-transparent",children:(0,n.jsxs)("div",{className:"text-center max-w-md mx-auto px-6",children:[(0,n.jsxs)("div",{className:"relative mb-8",children:[(0,n.jsxs)("div",{className:"relative mx-auto w-24 h-24 bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl shadow-2xl flex items-center justify-center transform hover:scale-105 transition-transform duration-300",children:[(0,n.jsxs)("div",{className:"text-white text-4xl",children:["searching"===S&&"\uD83D\uDD0D","preferring"===S&&"⚡","fetching"===S&&"\uD83C\uDFAC","ready"===S&&"✨"]}),(0,n.jsx)("div",{className:"absolute -inset-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl opacity-20 animate-spin"})]}),(0,n.jsxs)("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",children:[(0,n.jsx)("div",{className:"absolute top-2 left-2 w-2 h-2 bg-green-400 rounded-full animate-bounce"}),(0,n.jsx)("div",{className:"absolute top-4 right-4 w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce",style:{animationDelay:"0.5s"}}),(0,n.jsx)("div",{className:"absolute bottom-3 left-6 w-1 h-1 bg-lime-400 rounded-full animate-bounce",style:{animationDelay:"1s"}})]})]}),(0,n.jsxs)("div",{className:"mb-6 w-80 mx-auto",children:[(0,n.jsxs)("div",{className:"flex justify-center space-x-2 mb-4",children:[(0,n.jsx)("div",{className:"w-3 h-3 rounded-full transition-all duration-500 ".concat("searching"===S||"fetching"===S?"bg-green-500 scale-125":"preferring"===S||"ready"===S?"bg-green-500":"bg-gray-300")}),(0,n.jsx)("div",{className:"w-3 h-3 rounded-full transition-all duration-500 ".concat("preferring"===S?"bg-green-500 scale-125":"ready"===S?"bg-green-500":"bg-gray-300")}),(0,n.jsx)("div",{className:"w-3 h-3 rounded-full transition-all duration-500 ".concat("ready"===S?"bg-green-500 scale-125":"bg-gray-300")})]}),(0,n.jsx)("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:(0,n.jsx)("div",{className:"h-full bg-gradient-to-r from-green-500 to-emerald-600 rounded-full transition-all duration-1000 ease-out",style:{width:"searching"===S||"fetching"===S?"33%":"preferring"===S?"66%":"100%"}})})]}),(0,n.jsx)("div",{className:"space-y-2",children:(0,n.jsx)("p",{className:"text-xl font-semibold text-gray-800 dark:text-gray-200 animate-pulse",children:D})})]})})}):R?(0,n.jsx)(j.Z,{activePath:"/play",children:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-transparent",children:(0,n.jsxs)("div",{className:"text-center max-w-md mx-auto px-6",children:[(0,n.jsxs)("div",{className:"relative mb-8",children:[(0,n.jsxs)("div",{className:"relative mx-auto w-24 h-24 bg-gradient-to-r from-red-500 to-orange-500 rounded-2xl shadow-2xl flex items-center justify-center transform hover:scale-105 transition-transform duration-300",children:[(0,n.jsx)("div",{className:"text-white text-4xl",children:"\uD83D\uDE35"}),(0,n.jsx)("div",{className:"absolute -inset-2 bg-gradient-to-r from-red-500 to-orange-500 rounded-2xl opacity-20 animate-pulse"})]}),(0,n.jsxs)("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",children:[(0,n.jsx)("div",{className:"absolute top-2 left-2 w-2 h-2 bg-red-400 rounded-full animate-bounce"}),(0,n.jsx)("div",{className:"absolute top-4 right-4 w-1.5 h-1.5 bg-orange-400 rounded-full animate-bounce",style:{animationDelay:"0.5s"}}),(0,n.jsx)("div",{className:"absolute bottom-3 left-6 w-1 h-1 bg-yellow-400 rounded-full animate-bounce",style:{animationDelay:"1s"}})]})]}),(0,n.jsxs)("div",{className:"space-y-4 mb-8",children:[(0,n.jsx)("h2",{className:"text-2xl font-bold text-gray-800 dark:text-gray-200",children:"哎呀，出现了一些问题"}),(0,n.jsx)("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4",children:(0,n.jsx)("p",{className:"text-red-600 dark:text-red-400 font-medium",children:R})}),(0,n.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"请检查网络连接或尝试刷新页面"})]}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsx)("button",{onClick:()=>eo?u.push("/search?q=".concat(encodeURIComponent(eo))):u.back(),className:"w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-medium hover:from-green-600 hover:to-emerald-700 transform hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl",children:eo?"\uD83D\uDD0D 返回搜索":"← 返回上页"}),(0,n.jsx)("button",{onClick:()=>window.location.reload(),className:"w-full px-6 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200",children:"\uD83D\uDD04 重新尝试"})]})]})})}):(0,n.jsxs)(j.Z,{activePath:"/play",children:[(0,n.jsxs)("div",{className:"flex flex-col px-0 lg:px-[5rem] 2xl:px-32",children:[(0,n.jsx)("div",{children:(0,n.jsxs)("div",{className:"grid lg:h-[500px] xl:h-[650px] 2xl:h-[750px] grid-cols-1 md:grid-cols-4 md:gap-0",children:[(0,n.jsx)("div",{className:"h-full border-0 md:border-t md:border-b md:border-l md:border-white/0 md:dark:border-white/30 md:col-span-3",children:(0,n.jsxs)("div",{className:"relative w-full h-[300px] lg:h-full",children:[(0,n.jsx)("div",{ref:e9,className:"bg-black w-full h-full overflow-hidden shadow-lg"}),en&&(0,n.jsx)(b,{videoTitle:eo,isVisible:en,currentEpisode:ew+1,currentEpisodeTitle:null==T?void 0:null===(t=T.episodes_titles)||void 0===t?void 0:t[ew],onSelect:async(e,t)=>{let r=e.animeTitle;Q(r),es.current=r,ea(!1),ee(e),er(t),eR(!0)},onClose:()=>{ea(!1),e7.current&&e7.current.setting.update({name:"弹幕源",tooltip:eC||"未选择"})}}),e2&&(0,n.jsx)("div",{className:"absolute inset-0 bg-black/85 backdrop-blur-sm flex items-center justify-center z-[500] transition-all duration-300",children:(0,n.jsxs)("div",{className:"text-center max-w-md mx-auto px-6",children:[(0,n.jsxs)("div",{className:"relative mb-8",children:[(0,n.jsxs)("div",{className:"relative mx-auto w-24 h-24 bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl shadow-2xl flex items-center justify-center transform hover:scale-105 transition-transform duration-300",children:[(0,n.jsx)("div",{className:"text-white text-4xl",children:"\uD83C\uDFAC"}),(0,n.jsx)("div",{className:"absolute -inset-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl opacity-20 animate-spin"})]}),(0,n.jsxs)("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",children:[(0,n.jsx)("div",{className:"absolute top-2 left-2 w-2 h-2 bg-green-400 rounded-full animate-bounce"}),(0,n.jsx)("div",{className:"absolute top-4 right-4 w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce",style:{animationDelay:"0.5s"}}),(0,n.jsx)("div",{className:"absolute bottom-3 left-6 w-1 h-1 bg-lime-400 rounded-full animate-bounce",style:{animationDelay:"1s"}})]})]}),(0,n.jsx)("div",{className:"space-y-2",children:(0,n.jsx)("p",{className:"text-xl font-semibold text-white animate-pulse",children:"sourceChanging"===e4?"\uD83D\uDD04 切换播放源...":"optimizing"===e4?"⚡ 优选播放源...":"\uD83D\uDD04 视频加载中..."})})]})}),A&&(0,n.jsx)("div",{className:"absolute top-4 left-4 right-4 z-[400] flex justify-center",children:(0,n.jsx)("div",{className:"bg-gray-800/90 text-white px-4 py-2 rounded-lg shadow-lg",children:"正在自动加载弹幕..."})})]})}),(0,n.jsx)("div",{className:"h-[300px] lg:h-full md:overflow-hidden md:col-span-1",children:(0,n.jsx)(w,{totalEpisodes:eF,episodes_titles:(null==T?void 0:T.episodes_titles)||[],value:ew+1,onChange:th,onSourceChange:tm,currentSource:eg,currentId:ep,videoTitle:ey||eo,availableSources:eY,sourceSearchLoading:eK,sourceSearchError:eQ,precomputedVideoInfo:e0,preferBestSource:tn,setLoading:y,setIsVideoLoading:e5,setVideoLoadingStage:e3})})]})}),(0,n.jsx)("div",{className:"grid grid-cols-1 gap-4",children:(0,n.jsx)("div",{className:"w-full",children:(0,n.jsxs)("div",{className:"p-6 flex flex-col min-h-0",children:[(0,n.jsxs)("h1",{className:"text-3xl font-bold mb-2 tracking-wide flex items-center flex-shrink-0 text-center md:text-left w-full",children:[eo||"影片标题",eF>1&&(0,n.jsx)("span",{className:"text-gray-500 dark:text-gray-400 text-2xl ml-3",children:(null==T?void 0:null===(l=T.episodes_titles)||void 0===l?void 0:l[ew])||"第 ".concat(ew+1," 集")}),(0,n.jsx)("button",{onClick:e=>{e.stopPropagation(),tv()},className:"ml-3 flex-shrink-0 hover:opacity-80 transition-opacity",children:(0,n.jsx)(E,{filled:B})}),eU&&(0,n.jsx)("button",{onClick:()=>F(!0),className:"ml-3 flex-shrink-0 bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 hover:scale-[1.1] transition-all duration-300 ease-out shadow-md",title:"下载视频",children:(0,n.jsx)(s.Z,{className:"h-4 w-4"})}),0!==eh&&(0,n.jsx)("a",{href:"https://movie.douban.com/subject/".concat(eh.toString()),target:"_blank",rel:"noopener noreferrer",className:"ml-3 flex-shrink-0",children:(0,n.jsx)("div",{className:"bg-green-500 text-white text-xs font-bold w-8 h-8 rounded-full flex items-center justify-center shadow-md hover:bg-green-600 hover:scale-[1.1] transition-all duration-300 ease-out",children:(0,n.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),(0,n.jsx)("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]})})})]}),(0,n.jsxs)("div",{className:"flex flex-wrap items-center gap-3 text-base mb-4 opacity-80 flex-shrink-0",children:[(null==T?void 0:T.class)&&(0,n.jsx)("span",{className:"text-green-600 font-semibold",children:T.class}),((null==T?void 0:T.year)||ec)&&(0,n.jsx)("span",{children:(null==T?void 0:T.year)||ec}),(null==T?void 0:T.source_name)&&(0,n.jsx)("span",{className:"border border-gray-500/60 px-2 py-[1px] rounded",children:T.source_name}),(null==T?void 0:T.type_name)&&(0,n.jsx)("span",{children:T.type_name})]}),(null==T?void 0:T.desc)&&(0,n.jsx)("div",{className:"mt-0 text-base leading-relaxed opacity-90 overflow-y-auto pr-2 flex-1 min-h-0 scrollbar-hide",style:{whiteSpace:"pre-line"},children:T.desc})]})})})]}),(0,n.jsx)(p.Z,{isOpen:Z,onClose:()=>F(!1),onAddTask:e=>{window.dispatchEvent(new CustomEvent("addDownloadTask",{detail:e})),F(!1)},initialUrl:eU||"",initialTitle:"".concat(eo).concat(eF>1?"_".concat((null==T?void 0:null===(c=T.episodes_titles)||void 0===c?void 0:c[ew])||"第".concat(ew+1,"集")):""),skipConfig:z})]})}let E=e=>{let{filled:t}=e;return t?(0,n.jsx)("svg",{className:"h-7 w-7",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,n.jsx)("path",{d:"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z",fill:"#ef4444",stroke:"#ef4444",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}):(0,n.jsx)(l.Z,{className:"h-7 w-7 stroke-[1] text-gray-600 dark:text-gray-300"})};function C(){return(0,n.jsx)(i.Suspense,{fallback:(0,n.jsx)("div",{children:"Loading..."}),children:(0,n.jsx)(S,{})})}},5036:function(e,t,r){"use strict";var n=r(7569);t.Z=e=>{let{children:t}=e;return(0,n.jsx)(n.Fragment,{children:t})}}},function(e){e.O(0,[11,108,325,669,429,314,133,744],function(){return e(e.s=9887)}),_N_E=e.O()}]);